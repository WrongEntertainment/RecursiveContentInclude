#!/usr/bin/env node

/**
 * Module dependencies.
 */
var program = require('commander');
var CommanderUtils = require('commander-utils');
var pkg = require('../package.json');
var fs = require('fs');
var resi = require('../lib');
var util = require('util');

/**
 * Initialize the commander-utils module.
 */
CommanderUtils(program, pkg);

/**
 * Set some commander-utils specific settings.
 */
program
  .setDescription('Recursive Content Include')
  .addExamples([
    { description: 'Process a local file and print the result to console.',
      command:     'resi --input path/to/file.txt' },
    { description: 'Request a file and process it. Print the result to console.',
      command:     'resi --input http://url.to.file/' },
    { description: 'Process a file with custom begin/end tags (mustache style).',
      command:     'resi --begin-tag {{ --end-tag }} --input path/to/file.txt' }
  ]);

/**
 * The tool options.
 */
program
  .option('-i, --input <File>', 'the input, local file or web url')
  .option('-o, --output <File>', 'the file output')
  .option('--open-tag <String>', 'set the begin tag')
  .option('--close-tag <String>', 'set the end tag')
  .option('-e, --eval <String>', 'pass a string from the command line as input')
  .option('-t, --tokens', 'print out the tokens that the lexer produce');

/**
 * Parse it.
 */
program.parseUtils(process.argv);

/**
 * Variables
 */
var openTag = '<%>';
var closeTag = '</%>';

/**
 * The input
 */
if (program.input) {
  // Check if the input is an url.
  if (resi.lexer.isHttp(program.input)) {
    var request = require('request');
    request(program.input, function (error, response, body) {
      if (!error && response.statusCode == 200) {
        // Print only the lexer tokens
        if (program.tokens) {
          console.log('TODO, show tokens');
          resi.lexer.tokenize(body, openTag, closeTag);
        }
        // compile it
        else {
          var data = resi.compile(body, openTag, closeTag);
          outputHelper(data);
        }
      }
      else {
        program.log.warn('Request failed.');
        program.log.warn('Check if the web url is correct.');
      }
    });
  }
  // If it is no url, read the file
  else {
    // Print only the lexer tokens
    if (program.tokens) {
      var tokens = resi.lexer.tokenize(fs.readFileSync(program.input, 'utf8'), openTag, closeTag);
      program.log.info(util.inspect(tokens, false, null));
    }
    // compile it
    else {
      var data = resi.readFileSync(program.input, openTag, closeTag);
      outputHelper(data);
    }
  }
}
else if (program.eval) {
  program.log.info(resi.compile(program.eval, openTag, closeTag));
}

/**
 * Optional options
 */
if (program.openTag) {
  openTag = program.openTag;
  program.log.info('Set the begin Tag to: ' + openTag);
}
if (program.closeTag) {
  closeTag = program.closeTag;
  program.log.info('Set the end Tag to: ' + closeTag);
}

/**
 * save the file if the --output option was set.
 */
function outputHelper(data) {
  if (program.output) {
    program.log.info('Write file to ' + program.output);
    fs.writeFile(program.output, data, 'utf8', function() {
      program.log.info('File writer ready!');
    });
  }
  else {
    program.log.info(data);
  }
};